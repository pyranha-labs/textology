<!doctype html>
<html lang="en" class="fill-height ">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snapshot Test Results</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.css"
          integrity="sha384-Dv/31bNdy5iSIdT3DbFwGhN3LnetXu2VyL8xFYMqdHvfA1BFqWmoIHum+ocjdjtu" crossorigin="anonymous">
    <script src="https://unpkg.com/material-components-web@14.0.0/dist/material-components-web.min.js"
            integrity="sha384-NQs9Lm2CZqPDbiQog4Tl9+s+LYnPbrwOF7kGY1ks7rl5A7rJypS6Cuqt6HFYtPC+" crossorigin="anonymous"></script>
    <style>
        body {
            background: #dedede;
            margin: 0;
            padding: 0;
            --mdc-theme-primary: #546E7A;
            --mdc-theme-secondary: #3949AB;
        }

        .content {
            padding: 12px 12px 0;
            margin: 64px 0 0;
        }

        .mdc-drawer-app-content {
            flex: auto;
            overflow: auto;
            position: relative;
        }

        .main-content {
            overflow: auto;
            height: 100%;
        }

        .result-card {
            width: 100%;
            margin-bottom: 12px;
        }

        .result-card .card-title {
            display: flow-root;
            padding: 16px 16px 0;
        }

        .result-card .card-title .mdc-typography--headline6 {
            margin: 0;
        }

        .result-card .card-title .mdc-typography--subtitle2 {
            margin: 0;
        }

        .test-img-wrapper {
            flex: 1;
            margin-left: 8px;
            margin-right: 8px;
            word-break: break-word;
        }

        .test-img-diff {
            mix-blend-mode: difference;
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .test-img-header {
            flex: 1;
            margin-top: 0;
            margin-bottom: 0;
            text-align: center;
        }

        #test-details .mdc-dialog__header {
            padding: 8px 32px 0;
        }

        #test-details .mdc-dialog__content {
            padding: 8px 36px 8px;
        }

        #test-details-values-table {
            display: table;
            margin: auto;
        }

        .test-details-content {
            display: none;
        }

        .test-details-content--active {
            display: block;
        }

        .test-info-subtitle {
            padding: 0 0 12px;
        }

        .test-info-img-header {
            margin: 0;
        }

        .test-info-env-table {
            margin: auto;
        }

        .test-info-env-table tr {
            height: 42px !important;
        }

        .test-info-env-table td {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            height: 42px !important;
        }

        #help .mdc-dialog__header {
            padding: 16px 24px 0;
        }

        #help .mdc-dialog__content {
            padding: 8px 36px 8px;
        }

        .mdc-mega-footer {
            padding: 16px 40px;
            color: #9e9e9e;
            background-color: #424242;
        }

        .mdc-mega-footer__heading {
            position: relative;
            width: 100%;
            padding-right: 40px;
            margin: 24px 0 8px;
            box-sizing: border-box;
            font-size: 14px;
            line-height: 24px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            color: #e0e0e0;
        }

        .mdc-mega-footer__link-list {
            list-style: none;
            padding: 0;
            margin: 0 0 32px;
        }

        .mdc-mega-footer--link-list li, .mdc-mega-footer__link-list li {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0;
            line-height: 20px;
        }

        .mdc-mega-footer--link-list a, .mdc-mega-footer__link-list a {
            color: inherit;
            text-decoration: none;
            white-space: nowrap;
        }

        .mdc-mega-footer__bottom-section {
            padding-top: 16px;
            margin-bottom: 16px;
        }

        .mdc-logo {
            float: left;
            margin-bottom: 0;
            margin-right: 16px;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 0;
            line-height: 20px;
        }

        .flex-column {
            display: flex;
            flex-direction: column;
        }

        .overlay-container {
            position: relative;
        }

        .missing-img-placeholder {
            border: black 1px dashed;
            height: 100%;
            padding: 0;
        }

        .fill-height {
            height: 100%;
        }

        .mdc-drawer-app-content {
            padding-top: 0;
        }

        .missing-img-text {
            width: calc(100% - 32px);
            padding: 12px
        }

        .help-arg-body {
            padding: 0 24px 8px;
            margin: 0;
        }

        .copy-btn {
            height: 16px;
            min-width: 16px;
            padding: 0 0 0 4px;
        }

        .no-margin {
            margin: 0 !important;
        }

        .no-vertical-padding {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
    </style>
</head>

<body class="mdc-typography fill-height">

<noscript>You need to enable JavaScript to run this app.</noscript>

<div id="root" class="fill-height">
    <aside class="mdc-drawer mdc-drawer--modal">
        <div class="mdc-drawer__header">
            <h3 class="mdc-drawer__title">Snapshot Tests</h3>
        </div>
        <div class="mdc-drawer__content">
            <nav id="test-nav-links" class="mdc-list">
                <a class="mdc-deprecated-list-item" role="menuitem" onclick="navMDCTopAppBar()">
                    <span class="mdc-deprecated-list-item__ripple"></span>
                    <span class="mdc-deprecated-list-item__text">Link to test1</span>
                </a>
            </nav>
        </div>
    </aside>

    <div class="mdc-drawer-scrim"></div>

    <div class="drawer-frame-app-content fill-height">
        <header id="app-bar" class="mdc-top-app-bar drawer-top-app-bar mdc-elevation--z2">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                    <button class="mdc-icon-button material-icons mdc-top-app-bar__navigation-icon mdc-ripple-upgraded--unbounded mdc-ripple-upgraded">
                        menu
                    </button>
                    <span class="mdc-top-app-bar__title">Snapshot Test Results</span>
                </section>
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end">
                        <span id="page-subtitle" class="mdc-top-app-bar__subtitle">
                            {{ fail_count }} Failures
                        </span>
                </section>
            </div>
        </header>

        <div class="mdc-drawer-app-content mdc-top-app-bar--fixed-adjust fill-height">
            <main class="main-content flex-column" id="main-content">
                <div id="results" class="content">
                    <div id="result-template" class="mdc-card mdc-elevation--z2 result-card">
                        <div id="test-card-{{ elementIndex }}" class="card-title">
                            <h6 class="mdc-typography--headline6">{{ name }}</h6>
                            <div class="mdc-typography--subtitle2">
                                {{ path }}:{{ line }}
                            </div>
                        </div>

                        <div style="display: flex; width: 100%">
                            <h6 class="test-img-header mdc-typography--subtitle1">Result</h6>
                            <h6 class="test-img-header mdc-typography--subtitle1">Expected</h6>
                        </div>

                        <div style="display: flex">
                            <div class="test-img-wrapper">
                                {{ result }}
                            </div>
                            <div class="test-img-wrapper">
                                {{ expected }}
                            </div>
                        </div>

                        <div class="mdc-card__actions" style="display: flex">
                            <button class="mdc-button mdc-card__action mdc-card__action--button"
                                    onclick="showTestDetailsDialog('{{ index }}')">
                                <span class="mdc-button__ripple"></span>
                                <span class="mdc-button__label" tabindex="-1">Details</span>
                            </button>

                            <div style="flex: 1;"></div>

                            <div class="mdc-menu-surface--anchor">
                                <button id="test-menu-btn-{{ index }}"
                                        class="material-icons mdc-icon-button mdc-card__action mdc-card__action--icon"
                                        onclick="openMenu('test-menu-{{ index }}')">
                                    more_vert
                                </button>
                                <div id="test-menu-{{ index }}" class="mdc-menu mdc-menu-surface"
                                     style="transform-origin: center bottom; left: 0; bottom: 0;">
                                    <ul class="mdc-deprecated-list" role="menu" aria-hidden="true"
                                        aria-orientation="vertical" tabindex="-1">
                                        <li class="mdc-deprecated-list-item" role="menuitem"
                                            onclick="saveTestResult('{{ index }}')">
                                            <span class="mdc-deprecated-list-item__ripple"></span>
                                            <span class="mdc-deprecated-list-item__text">Download Result</span>
                                        </li>
                                        <li class="mdc-deprecated-list-item" role="menuitem"
                                            onclick="showTestDetailsDialog('{{ index }}')">
                                            <span class="mdc-deprecated-list-item__ripple"></span>
                                            <span class="mdc-deprecated-list-item__text">View Details</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="flex: 1;"></div>

                <footer id="test-footer" class="mdc-mega-footer no-vertical-padding">
                    <div class="mdc-mega-footer__middle-section">
                        <div class="mdc-mega-footer__drop-down-section">
                            <h1 class="mdc-mega-footer__heading">Links</h1>
                            <ul class="mdc-mega-footer__link-list" style="margin-bottom: 16px">
                                <li><a href="#test-card-1">Top</a></li>
                                <li><a href="javascript:openDialog('help');">Help</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="mdc-mega-footer__bottom-section no-margin">
                        <div class="mdc-logo">Snapshot Tests</div>
                        <ul class="mdc-mega-footer__link-list">
                            <li><a>Report created at {{ timestamp }}.</a></li>
                        </ul>
                    </div>
                </footer>

                <div id="test-details" class="mdc-dialog mdc-dialog--fullscreen">
                    <div class="mdc-dialog__container">
                        <div class="mdc-dialog__surface" role="alertdialog">
                            <div class="mdc-dialog__header" style="display: block;">
                                <div style="display: flex;">
                                    <h5 id="test-details-header" class="mdc-dialog__title mdc-typography--headline5">
                                        Details:
                                    </h5>
                                    <div style="flex: 1;"></div>
                                    <button class="mdc-icon-button material-icons mdc-dialog__close"
                                            data-mdc-dialog-action="close">
                                        close
                                    </button>
                                </div>

                                <div class="mdc-tab-bar" role="tablist" style="width: min-content; margin: auto;">
                                  <div class="mdc-tab-scroller">
                                    <div class="mdc-tab-scroller__scroll-area">
                                      <div class="mdc-tab-scroller__scroll-content">
                                          <button class="mdc-tab mdc-tab--active" role="tab" tabindex="0">
                                              <span class="mdc-tab__content">
                                                  <span class="mdc-tab__icon material-icons">photo_library</span>
                                                  <span class="mdc-tab__text-label">Results</span>
                                              </span>
                                              <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                                  <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                              </span>
                                              <span class="mdc-tab__ripple"></span>
                                          </button>
                                        <button class="mdc-tab mdc-tab--active" role="tab" tabindex="1">
                                          <span class="mdc-tab__content">
                                            <span class="mdc-tab__icon material-icons">list</span>
                                            <span class="mdc-tab__text-label">Values</span>
                                          </span>
                                          <span class="mdc-tab-indicator">
                                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                          </span>
                                          <span class="mdc-tab__ripple"></span>
                                        </button>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                            </div>

                            <div class="mdc-dialog__content mdc-typography--body2">
                                <div class="test-details-content test-details-content--active">
                                    <h6 class="mdc-typography--headline6 test-info-img-header">Result</h6>
                                    <div id="test-details-result-subtitle"
                                         class="test-info-subtitle">
                                        {{ path }}:{{ line }}
                                    </div>
                                    <div id="test-details-result-image">
                                        {{ result }}
                                    </div>

                                    <h6 class="mdc-typography--headline6 test-info-img-header">Expected</h6>
                                    <div id="test-details-expected-subtitle"
                                         class="test-info-subtitle">
                                        {{ expectedPath }}
                                    </div>
                                    <div id="test-details-expected-image">
                                        {{ expected }}
                                    </div>

                                    <h6 class="mdc-typography--headline6 test-info-img-header">Difference</h6>
                                    <div class="test-info-subtitle">
                                        Result - Expected
                                    </div>
                                    <div>
                                        <div class="overlay-container">
                                            <div id="test-details-diff-expected-image"
                                                 class="test-img-diff">
                                                {{ expected_diff }}
                                            </div>
                                        </div>
                                        <div id="test-details-diff-result-image">
                                            {{ result }}
                                        </div>
                                    </div>
                                </div>

                                <div class="test-details-content">
                                    <div id="test-details-values-table">
                                        {{ table }}
                                    </div>
                                </div>
                            </div>

                            <div class="mdc-dialog__actions">
                                <button type="button" class="mdc-button mdc-dialog__button"
                                        data-mdc-dialog-action="close">
                                    <span class="mdc-button__ripple"></span>
                                    <span class="mdc-button__label">Close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mdc-dialog__scrim"></div>
                </div>

                <div id="help" class="mdc-dialog mdc-dialog--fullscreen">
                    <div class="mdc-dialog__container">
                        <div class="mdc-dialog__surface" role="alertdialog">
                            <div class="mdc-dialog__header">
                                <h4 class="mdc-dialog__title mdc-typography--headline4">
                                    Help
                                </h4>
                            </div>
                            <div class="mdc-dialog__content mdc-typography--body2">
                                <b>How are snapshots created?</b><br>
                                Snapshot files are created by default with the following format:<br>
                                <code class="mdc-theme--primary">
                                    &lt;parent folder of test&gt;/snapshots/&lt;name of test&gt;.svg
                                </code><br>
                                <br>
                                This can be overridden by using the
                                <code class="mdc-theme--primary">compare_to</code>
                                argument when calling the
                                <code class="mdc-theme--primary">compare_snapshots</code>
                                fixture. If a test is renamed/moved, the original snapshot must be moved manually, or
                                <code class="mdc-theme--primary">--txtology-snap-update</code>
                                can be used with pytest to recreate.<br>
                                <br>
                                <b>What pytest options are available?</b><br>
                                <code class="mdc-theme--primary">--txtology-snap-report</code>
                                <button class="mdc-button copy-btn"
                                        onclick="copyAndToast('--txtology-snap-report', 'Copied argument.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                                <br>
                                <p class="help-arg-body">
                                    Path to store the final HTML report with snapshot test results.
                                </p>
                                <code class="mdc-theme--primary">--txtology-snap-root</code>
                                <button class="mdc-button copy-btn"
                                        onclick="copyAndToast('--txtology-snap-root', 'Copied argument.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                                <br>
                                <p class="help-arg-body">
                                    Path to store snapshot testing files, such as reports and pytest shared worker
                                    results.
                                </p>
                                <code class="mdc-theme--primary">--txtology-snap-template</code>
                                <button class="mdc-button copy-btn"
                                        onclick="copyAndToast('--txtology-snap-template', 'Copied argument.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                                <br>
                                <p class="help-arg-body">
                                    Custom template to use for the HTML report with snapshot test results.
                                </p>
                                <code class="mdc-theme--primary">--txtology-snap-update</code>
                                <button class="mdc-button copy-btn"
                                        onclick="copyAndToast('--txtology-snap-update', 'Copied argument.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                                <br>
                                <p class="help-arg-body">
                                    Update snapshot files to the new test results if they do not match.
                                </p>
                                <br>
                                For more information on available arguments, run:<br>
                                <code class="mdc-theme--primary">pytest --help</code>
                            </div>
                            <div class="mdc-dialog__actions">
                                <button type="button" class="mdc-button mdc-dialog__button"
                                        data-mdc-dialog-action="close">
                                    <span class="mdc-button__ripple"></span>
                                    <span class="mdc-button__label">Close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mdc-dialog__scrim"></div>
                </div>

                <aside class="mdc-snackbar">
                    <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
                        <div class="mdc-snackbar__label" aria-atomic="false"></div>
                        <div class="mdc-snackbar__actions" aria-atomic="true">
                            <button type="button" class="mdc-button mdc-snackbar__action">
                                <div class="mdc-button__ripple"></div>
                                <span class="mdc-button__label"></span>
                            </button>
                        </div>
                    </div>
                </aside>
            </main>
        </div>
    </div>
</div>

<script type="application/javascript">
    /**
     * MDC objects and actions.
     */

    // Refer to the following for MDC modules in JS.
    // https://material-components.github.io/material-components-web-catalog/
    // https://github.com/material-components/material-components-web/blob/master/packages/material-components-web/index.ts
    const topAppBar = new mdc.topAppBar.MDCTopAppBar.attachTo(document.getElementById("app-bar"));
    const drawer = new mdc.drawer.MDCDrawer.attachTo(document.querySelector(".mdc-drawer"));
    const snackbar = new mdc.snackbar.MDCSnackbar(document.querySelector(".mdc-snackbar"));
    const detailsTabBar = new mdc.tabBar.MDCTabBar(document.querySelector(".mdc-tab-bar"));

    topAppBar.setScrollTarget(document.getElementById("main-content"));
    topAppBar.listen("MDCTopAppBar:nav", navMDCTopAppBar);

    snackbar.listen("MDCSnackbar:closed", closedMDCSnackbar);
    snackbar.listen("MDCSnackbar:opening", openingMDCSnackbar);

    detailsTabBar.listen("MDCTabBar:activated", activatedMDCTabBar);

    const menus = {};
    const dialogs = {};
    const toasts = [];

    /**
     * Initialize all MDC elements.
     */
    function initAllMDC() {
        for (const el of document.querySelectorAll(".mdc-button")) {
            new mdc.ripple.MDCRipple(el);
        }
        for (const el of document.querySelectorAll(".mdc-deprecated-list-item")) {
            new mdc.ripple.MDCRipple(el);
        }

        for (const el of document.querySelectorAll(".mdc-menu")) {
            menus[el.id] = new mdc.menu.MDCMenu(el);
        }
        for (const el of document.querySelectorAll(".mdc-dialog")) {
            dialogs[el.id] = new mdc.dialog.MDCDialog(el);
        }
    }

    /**
     * Action to perform on "activated" event from MDCTabBar.
     *
     * @param {object} event Event metadata from tab being activated.
     * @param {object} event.detail.index Which tab was activated.
     */
    function activatedMDCTabBar(event) {
      document.querySelector(".test-details-content--active").classList.remove("test-details-content--active");
      document.querySelectorAll(".test-details-content")[event.detail.index].classList.add("test-details-content--active");
    }

    /**
     * Action to perform on "closed" event from MDCSnackbar.
     */
    function closedMDCSnackbar() {
        // If there are still pending toasts to show, open the next one.
        if (toasts.length) {
            snackbar.open();
        }
    }

    /**
     * Action to perform on "nav" action from MDCTopAppBar.
     */
    function navMDCTopAppBar() {
        drawer.open = !drawer.open;
    }

    /**
     * Action to perform on "opening" event from MDCSnackbar.
     */
    function openingMDCSnackbar() {
        // Open the next pending toast to display.
        if (toasts.length) {
            let toast = toasts.shift();
            snackbar.labelText = toast.labelText;
            snackbar.actionButtonText = toast.actionButtonText;
            snackbar.timeoutMs = toast.timeoutMs || 4000;
        } else {
            snackbar.close();
        }
    }

    /**
     * Show a named dialog.
     *
     * @param {string} id ID of a dialog to show to the user.
     */
    function openDialog(id) {
        dialogs[id].open();
    }

    /**
     * Show a named menu.
     *
     * @param {string} id ID of a menu to show to the user.
     */
    function openMenu(id) {
        menus[id].open = true;
    }

    /**
     * Show a short message to user.
     *
     * @param {string} message Message to display.
     * @param {number} timeoutMs Automatic dismiss timeout in milliseconds, between 4000 and 10000. -1 to disable.
     */
    function toast(message, timeoutMs = 4000) {
        // Instead of modifying the snackbar directly, add to a queue to ensure all messages shown in order.
        toasts.push({
            labelText: message,
            actionButtonText: "dismiss",
            timeoutMs: timeoutMs,
        });
        if (!snackbar.isOpen) {
            snackbar.open();
        }
    }
</script>

<script type="application/javascript">
    /**
     * General objects and actions.
     */

    let testResult = "DUMMIES";
    const testDummies = {
        "timestamp": "2022-02-02 02:02:02",
        "test_count": 2,
        "environment": {
            "cpus": 4,
            "cwd": "/development/textology",
            "host": "test-machine",
            "platform": "linux-macOS-windows",
            "timezone": "-0000",
            "user": "testdummy",
            "processor": "x86_64",
        },
        "libraries": {
            "pytest": "0.0.0",
            "pytest_asyncio": "1.1.1",
            "textology": "2.2.2",
            "textual": "3.3.3"
        },
        "python": {
            "compiler": "Clang",
            "implementation": "CPython",
            "version": "3.10.0"
        },
        "items": [
            {
                "name": "test_app1",
                "path": "/test/test_path1.py",
                "line": "123",
                "result": '<img src="test/snapshots/test_basic_app.svg">',
                "expected": '<img src="test/snapshots/test_basic_app.svg">',
                "expectedPath": "/test/snapshots/test_app1.svg",
                "app": {
                    "title": "BasicApp",
                    "python_class": "<class 'textology.test.basic_app.BasicApp'>",
                    "driver_class": "<class 'textual.drivers.linux_driver.LinuxDriver'>",
                    "classes": "-dark-mode",
                    "css_path": [],
                    "console": {
                        "size": [
                            204,
                            56
                        ]
                    }
                }
            },
            {
                "name": "test_app2",
                "path": "/test/test_path2.py",
                "line": "456",
                "result": '<img src="test/snapshots/test_basic_app.svg">',
                "expected": null,
                "expectedPath": "/test/snapshots/test_app2.svg",
                "app": {
                    "title": "BasicApp",
                    "python_class": "<class 'textology.test.basic_app.BasicApp'>",
                    "driver_class": "<class 'textual.drivers.linux_driver.LinuxDriver'>",
                    "classes": "-dark-mode",
                    "css_path": [],
                    "console": {
                        "size": [
                            204,
                            56
                        ]
                    }
                }
            },
        ]
    };
    if (testResult === "DUMMIES") {
        testResult = testDummies;
    }

    /**
     * Save text to the clipboard and display summary message to user.
     *
     * @param {string} value The payload to save to the user's clipboard.
     * @param {string} success The message to display to user when successful.
     * @param {string} failure The message to display to user when unsuccessful.
     */
    async function copyAndToast(value, success = "", failure = "") {
        let result = await copyToClipboard(`${value}`);
        if (result === "granted") {
            toast(success || `Copied to clipboard: ${value}`);
        } else {
            toast(failure || "Could not copy to clipboard. Check console for more details.");
        }
    }

    /**
     * Save a test's value to the clipboard and display summary message to user.
     *
     * @param {number} index Test index to load values for.
     * @param {string} key Name of the test value to save.
     */
    function copyTestValue(index, key) {
        let values = findTestValues(index);
        copyAndToast(values[key], `Copied ${key}'s value to clipboard.`)
    }

    /**
     * Save text to the clipboard.
     *
     * @param {string} text The payload to save to the user's clipboard.
     * @returns {Promise<string>} The permission result from the copy request, indicating if successful.
     */
    function copyToClipboard(text) {
        return new Promise(resolve => {
            navigator.permissions.query({name: "clipboard-write"})
                .then((result) => {
                    if (result.state === "granted") {
                        navigator.clipboard.writeText(text)
                            .then(() => {
                                console.log("Text copied to clipboard");
                            })
                            .catch((err) => {
                                console.error(`Could not copy text: ${err}`);
                            });
                    } else if (result.state === "denied") {
                        console.error("Clipboard access is not supported");
                    }
                    resolve(result.state);
                });
        });
    }

    /**
     * Escape HTML characters in a string to allow them to be displayed in other HTML elements
     *
     * @param {string} original Text with one of more HTML characters that need to be escaped for proper display.
     * @returns {string} New string with all HTML characters escaped.
     */
    function escapeHtml(original) {
        return original
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    /**
     * Find important values from a test for display.
     *
     * @param {number} index Test index to load values for.
     * @returns {object} All values from the test that should be shown to a user for quick reference.
     */
    function findTestValues(index) {
        let test = testResult.items[index];
        let values = {
            "test.path": test.path,
            "test.name": test.name,
            "test.line": test.line,
            "test.snapshot.path": test.expectedPath,
        };
        for (const [name, value] of Object.entries(flatten(test.app))) {
            values[`app.${name}`] = value;
        }
        for (const [name, value] of Object.entries(flatten(testResult.libraries))) {
            values[`version.${name}`] = value;
        }
        for (const [name, value] of Object.entries(flatten(testResult.python))) {
            values[`python.${name}`] = value;
        }
        for (const [name, value] of Object.entries(flatten(testResult.environment))) {
            values[`env.${name}`] = value;
        }
        return values;
    }

    /**
     * Convert a nested object into a flat object with multipart keys.
     *
     * @param {object} obj Original object with one or more nested levels of objects.
     * @param {string} baseKey Root key to prefix new keys with if not the first level.
     * @returns {object} Single level object with all keys from all levels.
     */
    function flatten(obj, baseKey) {
        let flat = {};
        Object.keys(obj).forEach((key) => {
            let value = obj[key];
            if (typeof value === "object" && value !== null && !Array.isArray(value)) {
                Object.assign(flat, flatten(value, key));
            } else {
                flat[baseKey ? `${baseKey}.${key}` : key] = value;
            }
        });
        return flat;
    }

    /**
     * Replace template values with variables.
     *
     * @param {string} template Text with templated values to replace (variables surrounding by double curly brackets).
     * @param {object} variables Key/value pairs to replace in the template.
     * @returns {string} The final result with all requested values injected if matching keys found in template.
     */
    function format(template, variables) {
        for (const [key, value] of Object.entries(variables)) {
            template = template.replaceAll(new RegExp(`\{\{\\s*${key}\\s*\}\}`, "g"), value);
        }
        return template;
    }

    /**
     * Update footer with details about the test results.
     *
     * @param {object} testResult Full metadata from the test run.
     */
    function loadFooter(testResult) {
        let footerEl = document.getElementById("test-footer");
        footerEl.outerHTML = format(footerEl.outerHTML, {
            "timestamp": testResult.timestamp,
        });
    }

    /**
     * Update topbar/header with details about the test results.
     *
     * @param {object} testResult Full metadata from the test run.
     */
    function loadHeader(testResult) {
        let subtitleEl = document.getElementById("page-subtitle");
        subtitleEl.outerHTML = format(subtitleEl.outerHTML, {
            fail_count: testResult.items.length,
        });
    }

    /**
     * Update navigation menu with details about the test results.
     *
     * @param {object} testResult Full metadata from the test run.
     */
    function loadMenu(testResult) {
        let links = "";
        for (const [index, test] of Object.entries(testResult.items)) {
            links += `
                <a class="mdc-deprecated-list-item" role="menuitem" href="#test-card-${parseInt(index) + 1}"
                    onclick="navMDCTopAppBar()">
                    <span class="mdc-deprecated-list-item__ripple"></span>
                    <span class="mdc-deprecated-list-item__text">${test.name}</span>
                </a>`;
        }
        document.getElementById("test-nav-links").innerHTML = links;
    }

    /**
     * Load details about a test into the detail's dialog.
     *
     * @param {number} index Test index to load values for.
     */
    function loadTestDetails(index) {
        let test = testResult.items[index];
        document.getElementById("test-details-header").innerHTML = `Details: ${test.name}`;

        document.getElementById("test-details-result-subtitle").innerHTML = `${test.path}:${test.line}`;
        if (test.result) {
            document.getElementById("test-details-result-image").innerHTML = test.result;
        }

        document.getElementById("test-details-expected-subtitle").innerHTML = test.expectedPath;
        if (test.expected) {
            document.getElementById("test-details-expected-image").innerHTML = test.expected;
        }

        document.getElementById("test-details-diff-result-image").innerHTML = test.result;
        if (test.expected_diff) {
            document.getElementById("test-details-diff-expected-image").innerHTML = test.expected;
        }

        let rows = "";
        for (const [name, value] of Object.entries(findTestValues(index))) {
            rows += `<tr class="mdc-data-table__row">
                <td class="mdc-data-table__cell">${name}</td>
                <td class="mdc-data-table__cell">${escapeHtml(String(value))}</td>
                <td class="mdc-data-table__cell no-vert-padding">
                    <button class="mdc-button copy-btn"
                            onclick="copyTestValue('${index}', '${name}');">
                        <i class="material-icons mdc-button__icon">content_copy</i>
                    </button>
                </td>
            </tr>`;
        }
        document.getElementById("test-details-values-table").innerHTML = `
            <div class="mdc-data-table">
                <div class="mdc-data-table__table-container">
                    <table class="mdc-data-table__table test-info-env-table">
                        <thead>
                            <tr class="mdc-data-table__header-row">
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Name</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col">Value</th>
                                <th class="mdc-data-table__header-cell" role="columnheader" scope="col"></th>
                            </tr>
                        </thead>
                        <tbody class="mdc-data-table__content">
                        ${rows}
                        </tbody>
                    </table>
                </div>
            </div>`;
    }

    /**
     * Update all elements with details about the test results.
     *
     * @param {object} testResult Full metadata from the test run.
     */
    function loadTests(testResult) {
        loadHeader(testResult);
        loadMenu(testResult);
        loadFooter(testResult);

        let templateEl = document.getElementById("result-template");
        let testTemplate = templateEl.outerHTML;
        templateEl.remove();

        let body = "";
        for (const [index, test] of Object.entries(testResult.items)) {
            test.index = parseInt(index);
            test.elementIndex = test.index  + 1;
            if (test.expected) {
                test.expected_diff = test.expected;
            } else {
                test.expected = format(`
                    <div class="missing-img-placeholder flex-column">
                        <div class="mdc-typography--body2 missing-img-text">
                            <b>No Snapshot</b><br>
                            The following location was checked for a snapshot, but was not found:<br>
                            <code class="mdc-theme--primary">{{ expectedPath }}</code>
                            <button class="mdc-button copy-btn"
                                onclick="copyAndToast('{{ expectedPath }}', 'Copied path.');">
                                <i class="material-icons mdc-button__icon">content_copy</i>
                            </button>
                            <br>
                            <br>
                            If the result is accurate, it can be saved by running:<br>
                            <code class="mdc-theme--primary">
                                # Update this test only:<br>
                                pytest --txtology-snap-update {{ path }} -k {{ name }}
                                <button class="mdc-button copy-btn"
                                    onclick="copyAndToast('pytest --txtology-snap-update {{ path }} -k {{ name }}', 'Copied command.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                                <br>
                                <br>
                                # Update all tests: <br>
                                pytest --txtology-snap-update
                                <button class="mdc-button copy-btn"
                                    onclick="copyAndToast('pytest --txtology-snap-update', 'Copied command.');">
                                    <i class="material-icons mdc-button__icon">content_copy</i>
                                </button>
                            </code>
                            <br>
                            <br>
                            Or to manually set the snapshot path, call the
                            <code class="mdc-theme--primary">compare_snapshots</code>
                            fixture with the following argument:<br>
                            <code class="mdc-theme--primary">compare_to="path to file"</code>
                            <button class="mdc-button copy-btn"
                                onclick="copyAndToast('compare_to=path_to_file', 'Copied argument.');">
                                <i class="material-icons mdc-button__icon">content_copy</i>
                            </button>
                        </div>
                        <button class="mdc-button mdc-card__action mdc-card__action--button" onclick="openDialog('help');">
                            <span class="mdc-button__ripple"></span>
                            <span class="mdc-button__label" tabindex="-1">Help</span>
                        </button>
                    </div>`,
                    test
                )
            }
            body += format(testTemplate, test);
        }
        document.getElementById("results").innerHTML = body;

        initAllMDC();
    }

    /**
     * Save the result image from a test to local machine.
     *
     * @param {number} index Test index to load values for.
     */
    function saveTestResult(index) {
        let test = testResult.items[parseInt(index)];
        if (!test.result) {
            return;
        }
        console.log("Saving result image for", index, test.name);
        saveTextFile(test.result, `${test.name}.svg`);
    }

    /**
     * Save a text file to the local machine.
     *
     * @param {string} content Text content to save to the file.
     * @param {string} fileName Base name of the file when saved.
     */
    function saveTextFile(content, fileName) {
        const link = document.createElement("a");
        const file = new Blob([content], {type: "text/plain"});
        link.href = URL.createObjectURL(file);
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    /**
     * Show a dialog with details about a specific test.
     *
     * @param {number} index Test index from results to show details for.
     */
    function showTestDetailsDialog(index) {
        loadTestDetails(index);
        openDialog("test-details");
    }

    loadTests(testResult);
</script>
</body>
</html>